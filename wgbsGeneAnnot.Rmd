---
title: "wgbsGeneAnnot"
author: "Maya Arvanitis"
date: "10/28/2024"
output: html_document
---

---
title: "wgbsGeneAnnot"
author: "Maya Arvanitis"
date: "10/28/2024"
output: html_document
---

## Introduction

Whole genome bisulfite sequencing (WGBS) is a powerful technique used to assess DNA methylation across the entire genome at single-base resolution. 

Unlike array-based methods, which focus on a limited set of CpG sites, WGBS provides a comprehensive view of methylation patterns, offering the potential to uncover novel regulatory elements and regions associated with gene expression.

However, a challenge with WGBS data is the lack of direct mapping between CpG sites and gene annotations, making it necessary to perform additional gene annotation steps to link methylation changes to specific genes and biological functions.

## Purpose of Gene Annotation in WGBS Analysis

The goal of gene annotation in WGBS analysis is to map CpG sites to their corresponding genes or regulatory regions, enabling functional interpretation of the observed methylation patterns. 

Without this mapping, it would be difficult to understand the biological significance of differentially methylated regions (DMRs) or sites, limiting the ability to link epigenetic changes to gene expression and cellular functions. 

Gene annotation allows researchers to perform downstream analyses such as gene set enrichment analysis, pathway analysis, and integration with other genomic data.

## Methodology

Gene annotation for WGBS involves linking CpG sites with nearby genes based on their genomic coordinates. This process can be challenging because WGBS data provides information on methylation at individual CpG sites scattered throughout the genome, rather than pre-defined CpG regions associated with genes. 

The following steps will be used to perform gene annotation:

1. **Mapping Genomic Coordinates to Genes:** 

   The first step is to map the coordinates of the CpG sites (chromosome, start, and end positions) to nearby genes. This can be done using external gene annotation databases such as Ensembl or UCSC, which provide the genomic locations of genes and other functional elements. Tools like `biomaRt` or `annotatr` can facilitate this process by querying these databases for gene information based on the provided coordinates.

2. **Annotating with Genomic Ranges:** 

   In cases where CpG sites do not fall directly within gene bodies, it may be necessary to extend the search to include nearby regulatory regions (e.g., promoters or enhancers) by using a genomic range overlap approach. This involves defining a window around each CpG site and checking for overlaps with annotated gene regions using packages like `GenomicRanges`.

3. **Validation and Cross-Referencing:** 

   To ensure the accuracy of the annotation, multiple sources of gene annotations can be used to cross-reference the mapped genes. For instance, gene assignments from both `biomaRt` and `annotatr` can be compared, and only consistent annotations may be retained.

4. **Handling Ambiguities:** 

   In some cases, a CpG site may overlap with more than one gene or may be located in intergenic regions. In such cases, appropriate rules will be defined to assign the CpG site to the most relevant gene, or to mark it as intergenic if no clear assignment can be made.

This gene annotation process is a crucial step in linking WGBS methylation data to biological functions, enabling a more meaningful interpretation of the epigenetic changes observed in the data.

Note: In this file I will be working with a sample of the differential methylation data (N = 10 000) simply for running time / debugging purposes.

```{r, results="hide", error = FALSE, message=FALSE, warning=FALSE}
# Load necessary libraries
library(biomaRt)
library(annotatr)
library(GenomicRanges)
library(dplyr)
library(readr)
library(ggplot2)
```

```{r}
# Read the data
diff_data <- readr::read_tsv("data_maya/WTvsG34R_CRX_10W.diff_meth.tsv.gz", col_names = TRUE)

# Inspect the data
print(head(diff_data))
```

We will filter the data to select for significant p-values first.
```{r}
significant_cpgs <- diff_data %>% filter(pvalue < 0.05)
```

Now, we can separate this data into 2 groups: 
1. p-values with positive changes (hypermethylation)
2. p-values with negative changes (hypomethylation)

```{r}
hyper_cpgs <- significant_cpgs %>% filter(meth.diff > 0)
hypo_cpgs <- significant_cpgs %>% filter(meth.diff < 0)

head(hyper_cpgs)
head(hypo_cpgs)
dim(hyper_cpgs)
dim(hypo_cpgs)
```

Now we have two groups we are working with:
1. `hyper_cpgs` : 629752
2. `hypo_cpgs` : 755228

We will now perform gene annotation using biomaRt.

```{r}
# Step 1: Mapping Genomic Coordinates to Genes using biomaRt
# Connect to the Ensembl database for mouse genome annotation
ensembl <- useMart("ensembl", dataset = "mmusculus_gene_ensembl", host = "https://asia.ensembl.org")
```

```{r}
#Gene annotation function -------------------------------------
# Step 2: Modify the `annotate_genes` function to join with `cpg_id` after retrieving annotations
annotate_genes <- function(data) {
    # Retrieve gene annotations based on chromosomal regions
    gene_annotations <- getBM(
        attributes = c("chromosome_name", "start_position", "end_position", "external_gene_name"),
        filters = "chromosomal_region",
        values = paste0(data$chr, ":", data$start, "-", data$end),
        mart = ensembl
    )
    # Rename columns to match `hyper_cpgs` column names for a successful join
    gene_annotations <- gene_annotations %>%
      rename(
        chr = chromosome_name,
        start = start_position,
        end = end_position,
        gene = external_gene_name
      )
    
    # Step 3: Merge with `data` by matching `chr`, `start`, `end`
    annotated_data <- merge(data, gene_annotations, by = c("chr", "start", "end"))
    return(annotated_data)
}

```

```{r}
# Step 1: Add CpG_ID to hyper_cpgs
hyper_cpgs <- hyper_cpgs %>%
  mutate(cpg_id = paste0(chr, "_", start, "_", end))

hypo_cpgs <- hypo_cpgs %>%
  mutate(cpg_id = paste0(chr, "_", start, "_", end))

head(hyper_cpgs)
head(hypo_cpgs)
```

```{r}
#Function calls for both hyper/hypo methylated CpGs 
hyper_genes <- annotate_genes(hyper_cpgs)
hypo_genes <- annotate_genes(hypo_cpgs)

head(hyper_genes)
head(hypo_genes)
```

```{r}
# Save the hyper_genes and hypo_genes objects as .rds files
saveRDS(hyper_genes, file = "hyper_genes.rds")
saveRDS(hypo_genes, file = "hypo_genes.rds")
```

```{r}
# Load the hyper_genes and hypo_genes objects from the .rds files
hyper_genes <- readRDS("rds/hyper_genes.rds")
hypo_genes <- readRDS("rds/hypo_genes.rds")
hyper_cpgs <- readRDS("rds/hyper_cpgs.rds")
hypo_cpgs <- readRDS("rds/hyper_cpgs.rds")
```



Create CpG Ids:
```{r}
# Step 1: Create a unique identifier for each CpG site based on chr, start, and end
hyper_cpgs <- hyper_cpgs %>%
  mutate(cpg_id = paste0(chr, "_", start, "_", end))

hyper_genes <- hyper_genes %>%
  mutate(cpg_id = paste0(chr, "_", start, "_", end))

# Step 2: Identify the common CpG IDs in both data frames
common_cpg_ids <- intersect(hyper_cpgs$cpg_id, hyper_genes$cpg_id)

# Step 3: Filter both data frames to keep only matching entries
filtered_hyper_cpgs <- hyper_cpgs %>% filter(cpg_id %in% common_cpg_ids)
filtered_hyper_genes <- hyper_genes %>% filter(cpg_id %in% common_cpg_ids)

# Optional: Arrange by cpg_id to align rows for further analysis or merging
filtered_hyper_cpgs <- filtered_hyper_cpgs %>% arrange(cpg_id)
filtered_hyper_genes <- filtered_hyper_genes %>% arrange(cpg_id)

# Check the filtered data frames
head(filtered_hyper_cpgs)
head(filtered_hyper_genes)

```

```{r}
library(methylGSA)
```

```{r}
# Check the first few rows to ensure the structure is correct
head(hyper_genes)
head(hyper_cpgs)
```

```{r}
# methylglm call for hypermethylated cpgs
methylglm_results_pos <- methylglm(
    cpg.pval = setNames(hyper_cpgs$pvalue, hyper_cpgs$cpg_id),
    array.type = "custom",
    FullAnnot = hyper_genes,
    GS.type = "GO",
    minsize = 200,
    maxsize = 500
)
```

```{r}
# methylglm call for hypomethylated cpgs 
methylglm_results_neg <- methylglm(
    cpg.pval = setNames(hypo_cpgs$pvalue, hypo_cpgs$cpg_id),
    array.type = "custom",
    FullAnnot = hypo_genes,
    GS.type = "GO",
    minsize = 200,
    maxsize = 500
)
```


