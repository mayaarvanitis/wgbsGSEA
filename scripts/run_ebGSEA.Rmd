---
title: "run_ebGSEA"
author: "Maya Arvanitis"
date: "11/18/2024"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Install remotes if not already installed
if (!requireNamespace("remotes", quietly = TRUE)) {
    install.packages("remotes")
}

# Install ebGSEA from GitHub
remotes::install_github("aet21/ebGSEA")
```

```{r}
# Load required packages
library(ebGSEA)
library(dplyr)
library(GenomicRanges)
library(biomaRt)
library(readr)
library(ggplot2)
library(dplyr)
```
```{r}
# Connect to Ensembl for mouse genome annotation
ensembl <- useMart("ensembl", dataset = "mmusculus_gene_ensembl")
```

We need to prepare two things: 
1. the phenotype vector 
2. the beta value matrix 

```{r}
library(msigdb)
```

```{r}
# Retrieve hallmark gene sets for mouse with Ensembl IDs
msigdb.mm <- getMsigdb(org = 'mm', id = 'SYM', version = '7.4')
hallmarks = subsetCollection(msigdb.mm, 'h')

# Convert hallmarks to a list of gene symbols by hallmark name
hallmarks_list <- lapply(hallmarks, function(gs) {
  # Extract gene symbols and set name for each GeneSet object
  setNames(list(gs@geneIds), gs@setName)
})

# Flatten the list structure to obtain a single list with hallmark names as keys
ptw.ls <- unlist(hallmarks_list, recursive = FALSE)
```

```{r}
# Load the percentage methylation data
percentage_meth <- read_tsv("data_maya/WTvsG34R_CRX_10W.percentage_meth.tsv.gz")

# Display the first few rows to confirm the structure
head(percentage_meth)
```

```{r}
# Ensure the data is a regular data frame
percentage_meth <- as.data.frame(percentage_meth)

# Extract only the columns with methylation percentages (assuming they start at column 5)
beta_values <- percentage_meth[, 5:ncol(percentage_meth)] / 100  # Convert percentages to beta values

# Convert the extracted values to a matrix
beta_matrix <- as.matrix(beta_values)

# Set row names as CpG site identifiers
rownames(beta_matrix) <- percentage_meth$id

# Display the dimensions and a preview of the matrix
cat("Dimensions of the beta matrix:", dim(beta_matrix), "\n")
head(beta_matrix)
```

```{r}
set.seed(123) # Ensure reproducibility

# Number of rows (CpGs) to select for the subset
num_rows <- 100   # Adjust this number as needed

# Ensure the subset size does not exceed the number of rows in the original beta matrix
num_rows <- min(num_rows, nrow(beta_matrix))

# Randomly sample rows (CpGs) while keeping all columns (samples)
beta_matrix_subset <- beta_matrix[sample(1:nrow(beta_matrix), num_rows), ]

# Display the dimensions and a preview of the subset
cat("Dimensions of the beta matrix subset:", dim(beta_matrix_subset), "\n")
print(head(beta_matrix_subset))

```

```{r}
# Create a phenotype vector
pheno.v <- c("SK059_2427_WT_CRX", "SK060_2616_WT_CRX", "SK061_2617_G34R_CRX", "SK062_2428_G34R_CRX")

# Display the phenotype vector
print(pheno.v)
```

```{r}
# Remove rows with any NA, NaN, or Inf values
beta_matrix_subset <- beta_matrix_subset[complete.cases(beta_matrix_subset) & 
                                         !apply(beta_matrix_subset, 1, function(row) any(is.nan(row) | is.infinite(row))), ]

# Display the updated dimensions
cat("Dimensions after removing problematic rows:", dim(beta_matrix_subset), "\n")
```

```{r}
# Ensure the matrix is numeric
beta_matrix_subset <- as.matrix(beta_matrix_subset)
storage.mode(beta_matrix_subset) <- "double"

# Check if all entries are numeric
if (!all(sapply(beta_matrix_subset, is.numeric))) {
  stop("Error: The matrix contains non-numeric values")
}

# Display a summary of the matrix
summary(beta_matrix_subset)
```

```{r}
source("doGT_custom.R")
```

```{r}
# Construct chromosomal_region in the query dataset
hyper_cpgs_subset <- hyper_cpgs_subset %>%
  mutate(query_id = paste0(chr, "_", start, "_", end),
         chromosomal_region = paste0(chr, ":", start, "-", end))

# Retrieve gene annotations for hypermethylated CpGs
hyper_annotations <- getBM(
  attributes = c("chromosome_name", "start_position", "end_position", "external_gene_name"),
  filters = "chromosomal_region",
  values = hyper_cpgs_subset$chromosomal_region,
  mart = ensembl
)

# Add chromosomal_region column to the result
hyper_annotations <- hyper_annotations %>%
  mutate(chromosomal_region = paste0(chromosome_name, "_", start_position, "_", end_position))

# Filter out rows with NA in the external_gene_name column
hyper_annotations <- hyper_annotations %>%
  filter(!is.na(external_gene_name) & external_gene_name != "" & !grepl("^\\s*$", external_gene_name))

# Display the first few rows to confirm
head(hyper_annotations)
```


```{r}
library(dplyr)
library(tibble)

# Convert `mapped_genes` into a list where each CpG ID is associated with one or more gene names
custom_mapping <- mapped_genes %>%
  group_by(cpg_id) %>%
  summarise(genes = list(unique(external_gene_name))) %>%
  deframe()

# Display a preview of the custom mapping
head(custom_mapping, 15)
```

```{r}
library(parallel)
library(ebGSEA)

# Run Global Test with a workaround
tryCatch({
  sgt.m <- doGT_custom(
    pheno.v = pheno.v,
    data.m = beta_matrix_subset,
    model = c("linear"),
    array = "custom",
    ncores = 4,
    custom_map = custom_mapping
  )
  print("Global Test completed successfully")
  print(head(sgt.m))
}, error = function(e) {
  cat("Error in doGT:", e$message, "\n")
})
```
```{r}
common_cpgs <- intersect(rownames(beta_matrix_subset), names(custom_mapping))
cat("Number of common CpGs:", length(common_cpgs), "\n")
```

```{r}
# Load pre-defined gene sets (you can use MSigDB hallmark sets or custom sets)

# Run pathway enrichment analysis
topGSEA.lm <- doGSEAwt(
  rankEID.m = sgt.m,
  ptw.ls = ptw.ls,
  ncores = 4,
  minN = 5,
  adjPVth = 0.05
)

# Display top results
head(topGSEA.lm[[1]])
```

```{r}
library(ebGSEA)

# Prepare phenotype vector
pheno.v <- c(0, 0, 1, 1)

# Run Global Test with a workaround
tryCatch({
  sgt.m <- doGT(
    pheno.v = pheno.v,
    data.m = beta_matrix_subset,
    array = "EPIC",  # Use "EPIC" as a workaround if custom type fails
    ncores = 4
  )
  print("Global Test completed successfully")
  print(head(sgt.m))
}, error = function(e) {
  cat("Error in doGT:", e$message, "\n")
})
```

```{r}
# Plot the AUC and adjusted p-values
ggplot(topGSEA.lm[[1]], aes(x = AUC, y = -log10(adjP))) +
  geom_point() +
  labs(x = "Area Under Curve", y = "-log10(Adjusted p-value)", title = "Pathway Enrichment Analysis") +
  theme_minimal()
```
